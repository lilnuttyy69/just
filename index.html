<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meme Coin Chaos</title>
<style>
body { font-family: Arial; background:#111; color:#fff; text-align:center; margin:0; }
.coin { margin:12px auto; padding:8px; border:1px solid #444; width:90%; max-width:420px; border-radius:5px; }
button { margin:3px; padding:4px 8px; background:#555; color:white; border:none; border-radius:4px; cursor:pointer; }
button:hover { background:#777; }
input { width:70px; text-align:center; }
canvas { background:black; width:100%; height:100px; display:block; margin:6px 0; }
#news, #sentiment, #portfolio-container { background:#222; margin:10px auto; padding:8px; width:90%; max-width:420px; border-radius:5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Meme Coin Chaos</h1>
<div id="news">Market stable... for now.</div>
<div id="sentiment">Market Sentiment: Neutral</div>

<h3>Cash: $<span id="cash">0</span></h3>
<h3>Net Worth: $<span id="networth">0</span></h3>

<button id="tap-money"></button>
<button id="upgrade-tap"></button>

<div id="portfolio-container">
<h3>Portfolio: $<span id="portfolio-value">0</span></h3>
<canvas id="portfolio-chart"></canvas>
</div>

<div id="coins"></div>

<script>
// ------------------ GLOBALS ------------------
const STORAGE_KEY = "memeCoinChaosV4";

let cash = 1000;
let tapValue = 5;
let tapUpgradeCost = 1000;

let portfolioHistory = [];

const TRANSACTION_FEE = 0.01;
const STAKE_YIELD = 0.002;

let coins = [
{name:"DogeLordX", basePrice:1, price:1, volatility:0.05, holdings:0, staked:0, trend:0, history:[]},
{name:"QuantumPepe", basePrice:2, price:2, volatility:0.07, holdings:0, staked:0, trend:0, history:[]},
{name:"MoonRaccoon", basePrice:0.5, price:0.5, volatility:0.1, holdings:0, staked:0, trend:0, history:[]},
{name:"AstroCat", basePrice:0.8, price:0.8, volatility:0.06, holdings:0, staked:0, trend:0, history:[]},
{name:"RoboFrog", basePrice:1.5, price:1.5, volatility:0.08, holdings:0, staked:0, trend:0, history:[]},
{name:"GalaxyDog", basePrice:2, price:2, volatility:0.05, holdings:0, staked:0, trend:0, history:[]}
];

let crashActive = false;
let lastCrashDelay = 0;
let marketGreedLevel = 0;
let lastWhaleCrashTime = 0;
const WHALE_CRASH_COOLDOWN = 60*60*1000;

// ------------------ SAVE / LOAD ------------------
function saveGame(){
    const save = { cash, tapValue, tapUpgradeCost, coins, portfolioHistory };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(save));
}

function loadGame(){
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if(data){
        cash = data.cash;
        tapValue = data.tapValue;
        tapUpgradeCost = data.tapUpgradeCost;
        coins = data.coins;
        portfolioHistory = data.portfolioHistory;
    }
}

// ------------------ INIT ------------------
function initCoins(){
    loadGame();
    const container=document.getElementById("coins");
    container.innerHTML="";
    coins.forEach((c,i)=>{
        container.innerHTML+=`
        <div class="coin">
            <h2 onclick="showCoinInfo(${i})" style="cursor:pointer">${c.name} â“˜</h2>
            <p>Price: $<span id="price-${i}">0</span></p>
            <p>Owned: <span id="owned-${i}">0</span> | Staked: <span id="staked-${i}">0</span></p>
            <p>P/L: $<span id="pl-${i}">0</span></p>
            <input type="number" id="amt-${i}" value="10">
            <button onclick="buyByCash(${i})">Buy $</button>
            <button onclick="buyMax(${i})">Buy Max</button>
            <button onclick="stakeCoin(${i})">Stake</button>
            <button onclick="unstakeCoin(${i})">Unstake</button>
            <button onclick="sellHoldings(${i})">Sell Holdings</button>
            <canvas id="chart-${i}"></canvas>
        </div>`;
    });
}

initCoins();

// ------------------ TAP SYSTEM ------------------
function updateTapButtons(){
    document.getElementById("tap-money").innerText=`Tap $${tapValue}`;
    document.getElementById("upgrade-tap").innerText=`Upgrade Tap ($${tapUpgradeCost})`;
}

document.getElementById("tap-money").onclick=()=>{
    cash += tapValue;
    updateGameUI();
};

document.getElementById("upgrade-tap").onclick=()=>{
    if(cash>=tapUpgradeCost){
        cash-=tapUpgradeCost;
        tapValue*=2;
        tapUpgradeCost=Math.floor(tapUpgradeCost*2.2);
        updateTapButtons();
        updateGameUI();
    }
};

updateTapButtons();

// ------------------ BUY / SELL ------------------
function buyByCash(i){
    let amt=parseFloat(document.getElementById(`amt-${i}`).value)||0;
    let spend=Math.min(amt,cash);
    if(spend<=0) return;
    let fee=spend*TRANSACTION_FEE;
    let qty=(spend-fee)/coins[i].price;
    coins[i].holdings+=qty;
    cash-=spend;
    updateGameUI();
}

function buyMax(i){
    if(cash<=0) return;
    let spend=cash;
    let fee=spend*TRANSACTION_FEE;
    let qty=(spend-fee)/coins[i].price;
    coins[i].holdings+=qty;
    cash=0;
    updateGameUI();
}

function sellHoldings(i){
    let total=coins[i].holdings;
    if(total<=0) return;
    let gross=total*coins[i].price;
    let fee=gross*TRANSACTION_FEE;
    cash+=gross-fee;
    coins[i].holdings=0;
    updateGameUI();
}

// ------------------ STAKING ------------------
function stakeCoin(i){
    if(coins[i].holdings<=0) return;
    coins[i].staked+=coins[i].holdings;
    coins[i].holdings=0;
    updateGameUI();
}

function unstakeCoin(i){
    if(coins[i].staked<=0) return;
    coins[i].holdings+=coins[i].staked;
    coins[i].staked=0;
    updateGameUI();
}

// ------------------ MARKET LOGIC ------------------
function updateMarket(){
    coins.forEach(c=>{
        c.trend+=(Math.random()-0.5)*0.01;
        let change=(c.trend+(Math.random()-0.5)*c.volatility)*c.price;
        c.price+=change;
        c.price+=(c.basePrice-c.price)*0.001;
        c.price=Math.max(c.price,0.01);
        if(c.staked>0) c.staked+=c.staked*STAKE_YIELD;
        c.history.push(c.price);
        if(c.history.length>50) c.history.shift();
    });
}

// ------------------ SENTIMENT ------------------
function updateSentiment(){
    let avg=coins.reduce((s,c)=>s+c.trend,0)/coins.length;
    marketGreedLevel=avg*20;
    let text="Neutral";
    if(marketGreedLevel>0.6) text="Extreme Greed ðŸš€ðŸš€";
    else if(marketGreedLevel>0.2) text="Greed ðŸš€";
    else if(marketGreedLevel<-0.6) text="Extreme Fear ðŸ˜±ðŸ˜±";
    else if(marketGreedLevel<-0.2) text="Fear ðŸ˜±";
    document.getElementById("sentiment").innerText="Market Sentiment: "+text;
}

// ------------------ CRASH SYSTEM ------------------
function triggerMarketCrash(source="normal"){
    if(crashActive) return;
    crashActive=true;
    let strength=0.25+Math.random()*0.25;
    document.getElementById("news").innerText=
        source==="whale"?"ðŸ‹ Whale Liquidity Shock!":"âš ï¸ GLOBAL MARKET CRASH!";
    coins.forEach(c=>{ c.price*=(1-strength); });
    updateGameUI();
    setTimeout(()=>{ crashActive=false; },10000);
}

function scheduleNextCrash(){
    let min=6*60*1000, max=15*60*1000, delay;
    do{ delay=Math.floor(Math.random()*(max-min))+min; }while(delay===lastCrashDelay);
    lastCrashDelay=delay;
    setTimeout(()=>{
        let chance=0.25;
        if(marketGreedLevel>0.6) chance+=0.4;
        if(Math.random()<chance) triggerMarketCrash("normal");
        scheduleNextCrash();
    },delay);
}
scheduleNextCrash();

// ------------------ WHALE BOT ------------------
function whaleBot(){
    let now=Date.now();
    let canCrash=(now-lastWhaleCrashTime)>WHALE_CRASH_COOLDOWN;
    let c=coins[Math.floor(Math.random()*coins.length)];
    if(canCrash && !crashActive && Math.random()<0.2){
        lastWhaleCrashTime=now;
        triggerMarketCrash("whale");
        return;
    }
    let direction=Math.random()>0.5?1:-1;
    c.price+=direction*(c.price*0.15*(0.5+Math.random()));
    document.getElementById("news").innerText=
        direction>0?`ðŸ‹ Whale pumped ${c.name}!`:`ðŸ‹ Whale dumped ${c.name}!`;
    updateGameUI();
}
setInterval(whaleBot,20000);

// ------------------ UI ------------------
function getNetWorth(){
    return cash+coins.reduce((s,c)=>s+(c.holdings+c.staked)*c.price,0);
}

function trackPortfolio(){
    portfolioHistory.push(getNetWorth());
    if(portfolioHistory.length>50) portfolioHistory.shift();
}

let portfolioChart=null;
function drawPortfolioChart(){
    const ctx=document.getElementById("portfolio-chart").getContext("2d");
    if(!portfolioChart){
        portfolioChart=new Chart(ctx,{type:'line',data:{labels:Array(portfolioHistory.length).fill(''),datasets:[{label:'Portfolio',data:portfolioHistory,borderColor:'lime',fill:false,lineTension:0}]},options:{responsive:true,animation:false,scales:{y:{beginAtZero:false}}}});
    } else {
        portfolioChart.data.datasets[0].data=[...portfolioHistory];
        portfolioChart.update();
    }
}

let coinCharts=[];
function drawCoinChart(i){
    const ctx=document.getElementById(`chart-${i}`).getContext("2d");
    if(!coinCharts[i]){
        coinCharts[i]=new Chart(ctx,{type:'line',data:{labels:Array(coins[i].history.length).fill(''),datasets:[{label:coins[i].name,data:coins[i].history,borderColor:'cyan',fill:false,lineTension:0}]},options:{responsive:true,animation:false,scales:{y:{beginAtZero:false}}}});
    } else {
        coinCharts[i].data.datasets[0].data=[...coins[i].history];
        coinCharts[i].update();
    }
}

function updateGameUI(){
    updateSentiment();
    trackPortfolio();
    drawPortfolioChart();
    let net=getNetWorth();
    document.getElementById("cash").innerText=cash.toFixed(2);
    document.getElementById("networth").innerText=net.toFixed(2);
    document.getElementById("portfolio-value").innerText=net.toFixed(2);
    coins.forEach((c,i)=>{
        document.getElementById(`price-${i}`).innerText=c.price.toFixed(2);
        document.getElementById(`owned-${i}`).innerText=c.holdings.toFixed(4);
        document.getElementById(`staked-${i}`).innerText=c.staked.toFixed(4);
        document.getElementById(`pl-${i}`).innerText=((c.holdings+c.staked)*c.price).toFixed(2);
        drawCoinChart(i);
    });
    saveGame();
}

function showCoinInfo(i){
    let c=coins[i];
    alert(`${c.name}\nBase Price: $${c.basePrice}\nCurrent Price: $${c.price.toFixed(2)}\nStaked: ${c.staked.toFixed(4)}`);
}

// ------------------ GAME LOOP ------------------
function gameLoop(){
    updateMarket();
    updateGameUI();
}
setInterval(gameLoop,1000);
updateGameUI();

</script>
</body>
</html>
